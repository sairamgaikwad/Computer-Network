import socket
import threading
import os
import tkinter as tk
from tkinter import scrolledtext

PORT = 5000
SHARED_FOLDER = "shared"

def start_server(log_widget):
    def handle_client(conn, addr):
        try:
            filename = conn.recv(1024).decode()
            filepath = os.path.join(SHARED_FOLDER, filename)

            if os.path.exists(filepath):
                conn.send(b"FOUND")
                with open(filepath, "rb") as f:
                    conn.sendfile(f)
                log_widget.insert(tk.END, f"[✓] Sent '{filename}' to {addr}\n")
            else:
                conn.send(b"NOT_FOUND")
                log_widget.insert(tk.END, f"[✗] File '{filename}' not found for {addr}\n")
        except Exception as e:
            log_widget.insert(tk.END, f"[!] Error with {addr}: {e}\n")
        finally:
            conn.close()

    def server_thread():
        if not os.path.exists(SHARED_FOLDER):
            os.makedirs(SHARED_FOLDER)

        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.bind(('', PORT))
        s.listen(5)
        log_widget.insert(tk.END, f"[+] Server started on port {PORT}\n")

        while True:
            conn, addr = s.accept()
            threading.Thread(target=handle_client, args=(conn, addr), daemon=True).start()

    threading.Thread(target=server_thread, daemon=True).start()

# GUI Setup
root = tk.Tk()
root.title("P2P Server")
root.geometry("500x400")

tk.Label(root, text="Peer-to-Peer File Server", font=("Arial", 14)).pack(pady=10)
tk.Button(root, text="Start Server", command=lambda: start_server(log), bg="green", fg="white").pack(pady=5)

log = scrolledtext.ScrolledText(root, height=15)
log.pack(fill=tk.BOTH, expand=True)

root.mainloop()
